let storiesArr = [
  {
    id: 1,
    owner: "Thanh Minh",
    avatar:
      "https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=2734&q=80",
    images: [
      {
        id: 1,
        src: "/assets/story1.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story2.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story3.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story4.jpeg",
        type: "img",
      },
    ],
  },
  {
    id: 2,
    owner: "Wendy",
    avatar:
      "https://i.pinimg.com/564x/20/6c/f0/206cf049e354147aba5bc5e35796b7ad.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story5.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story6.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story7.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story8.jpeg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story9.jpeg",
        type: "img",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "https://i.pinimg.com/564x/de/43/91/de43917acb4a60625340d8bf9b7fd3c0.jpg",
        type: "img",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
  {
    id: 2,
    owner: "SeungWan",
    avatar:
      "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
    images: [
      {
        id: 1,
        src: "/assets/story10.mp4",
        type: "video",
      },
      {
        id: 1,
        src: "/assets/story11.mp4",
        type: "video",
      },
    ],
  },
];
//Element declaration
const wrapperElement = document.querySelector(".wrapper");
const sliderElement = document.querySelector(".story-slider");
const slideLeftBtnElement = document.querySelector(".btn-left");
const slideRightBtnElement = document.querySelector(".btn-right");
const storyNextBtnElement = document.querySelector(".next-btn");
const storyPrevBtnElement = document.querySelector(".prev-btn");
let listSlideElement;
let currentVideoStoryElement;
let passedMediaThumbElement;
let listStoryMediaElement;
let currentStoryElement;
/////
let currentStoryMediaType;
let currentStoryIndex = 0;
let currentStoryMediaIndex = 0;
let storyMediaTimeout = 0;
let storyMediaRunningState = true;
let storyRemaining = 5000;
let storyMediaThumbRemaining = 5000;
let slideComputedStyleItem;
let startTimeOfStoryMedia;

function addIsSeenPropToStoryArray() {
  storiesArr.map((item) => (item.isSeen = false));
}
addIsSeenPropToStoryArray();

function getStoryArrayFromLocal() {
  const arrLocal = JSON.parse(localStorage.getItem("storiesArr"));
  storiesArr = arrLocal && arrLocal.length > 0 ? arrLocal : storiesArr;
}
getStoryArrayFromLocal();

function filterStoryArrayToSeenArray(array) {
  const newArray = array.reduce((currentArray, currentItem) => {
    if (currentItem.isSeen) {
      currentArray.push({ ...currentItem, isWatching: 0 });
    }
    return currentArray;
  }, []);
  return newArray;
}
function filterStoryArrayToNotSeenArray(array) {
  const newArray = array.filter((item) => !item.isSeen);
  return newArray;
}
function setIsWatchingMediaToMediaIndex() {
  const isWatchingStoryItemIndex = storiesArr[currentStoryIndex].isWatching
    ? storiesArr[currentStoryIndex].isWatching
    : 0;
  currentStoryMediaIndex = isWatchingStoryItemIndex;
}
function moveSeenStoryToTheBack() {
  const seenStoryArray = filterStoryArrayToSeenArray(storiesArr);
  const notSeenStoryArray = filterStoryArrayToNotSeenArray(storiesArr);
  storiesArr = [...notSeenStoryArray, ...seenStoryArray];
  setIsWatchingMediaToMediaIndex();
}
moveSeenStoryToTheBack();

function renderStorySlider() {
  const storyItemListHtml = storiesArr
    .map(
      (item, index) =>
        `
        <div onclick="handleClickStorySlideItem(${index})" class="${
          item.isSeen ? "is-seen" : ""
        } ${index === 0 ? "is-watching" : ""}  slide-item">
          <img class="avatar" src="${item.avatar}">
        </div>
      `
    )
    .join("");
  sliderElement.innerHTML = storyItemListHtml;
  listSlideElement = document.querySelectorAll(".slide-item");
}
renderStorySlider();

slideLeftBtnElement.addEventListener("click", moveStorySliderToLeft);
function moveStorySliderToLeft() {
  slideComputedStyleItem = window.getComputedStyle(listSlideElement[0]);
  sliderElement.scrollLeft =
    -(
      sliderElement.scrollLeft +
      listSlideElement[0].clientWidth +
      parseInt(slideComputedStyleItem.marginRight, 10)
    ) * 3;
}
slideRightBtnElement.addEventListener("click", moveStorySliderToRight);
function moveStorySliderToRight() {
  slideComputedStyleItem = window.getComputedStyle(listSlideElement[0]);
  sliderElement.scrollLeft =
    (sliderElement.scrollLeft +
      listSlideElement[0].clientWidth +
      parseInt(slideComputedStyleItem.marginRight, 10)) *
    3;
}

function handleClickStorySlideItem(index) {
  clearTimeout(storyMediaTimeout);
  setIsWatchingStoryColor(currentStoryIndex, index);
  currentStoryIndex = index;
  setIsWatchingMediaToMediaIndex();
  handleSetMediaRemainingTime(5000);
  startTimeOfStoryMedia = Date.now();
  renderStoryMedia();
}
function renderStoryMedia() {
  const storyItemHtml = `<div onclick="toggleStoryState()" class="story">
  <div class="time-line">
    ${storiesArr[currentStoryIndex].images.map((item, index) => {
      return `
            <div class="line-wrap ">
      <div class="line"></div>
      <div  class="passed ${
        index >= currentStoryMediaIndex ? "" : "done"
      }"></div>
    </div>`;
    })}
  </div>
  <div class="slider">
      ${storiesArr[currentStoryIndex].images
        .map((item, childIndex) => {
          return `
          <div class="item ${
            currentStoryMediaIndex === childIndex ? "is-active" : ""
          } ">
       ${
         item.type === "img"
           ? `<img src="${item.src}" alt="" />`
           : `
      <video class="video" >
          <source src="${item.src}" type="video/mp4">
      </video> `
       }
    </div>`;
        })
        .join("")}
  </div>
</div>`;
  wrapperElement.innerHTML = storyItemHtml;
  saveStoryArrayToLocal(storiesArr);
  startRunningStory();
}
renderStoryMedia();

function startRunningStory() {
  currentStoryMediaType =
    storiesArr[currentStoryIndex].images[currentStoryMediaIndex].type;
  listStoryMediaElement = document.querySelectorAll(".item");
  if (currentStoryMediaType === "video") {
    currentVideoStoryElement =
      listStoryMediaElement[currentStoryMediaIndex].querySelector(".video");
    currentVideoStoryElement.addEventListener("loadeddata", () => {
      handleSetMediaRemainingTime("beforePause");
    });
  } else {
    handleSetMediaRemainingTime("beforePause");
  }
}

function setStoryMediaRemainingTime(time) {
  storyRemaining = time;
  storyMediaThumbRemaining = time;
}

function checkVideoBrowserPermission(video) {
  if (video) {
    video
      .play()
      .then(() => {
        video.play();
        const currentStory = document.querySelector(".story");
        currentStory.classList.remove("pause");
      })
      .catch(() => {
        toggleStoryState();
      });
  }
}
function handleSetMediaRemainingTime(type) {
  if (type === "beforePause") {
    if (currentStoryMediaType === "video") {
      const videoRemaning = currentVideoStoryElement.duration * 1000;
      setStoryMediaRemainingTime(videoRemaning);
      checkVideoBrowserPermission(currentVideoStoryElement);
    }
  }
  passedMediaThumbElement =
    document.querySelectorAll(".passed")[currentStoryMediaIndex];
  passedMediaThumbElement.style.animation = `thumb ${Math.round(
    (storyMediaThumbRemaining + 300) / 1000
  )}s linear`;
  startTimeOfStoryMedia = Date.now();
  storyMediaTimeout = setTimeout(() => {
    nextStoryMedia();
  }, Math.round(storyRemaining - 100));
}
function toggleStoryState() {
  listStoryMediaElement = document.querySelectorAll(".item");
  currentVideoStoryElement =
    listStoryMediaElement[currentStoryMediaIndex].querySelector(".video");
  currentStoryElement = document.querySelector(".story");
  if (storyMediaTimeout) clearTimeout(storyMediaTimeout);
  if (storyMediaRunningState) {
    pauseStory();
  } else {
    playStory();
  }
}
function pauseStory() {
  if (currentStoryMediaType === "video") {
    currentVideoStoryElement.pause();
  }
  currentStoryElement.classList.add("pause");
  passedMediaThumbElement.style.animationPlayState = "paused";
  storyMediaRunningState = false;
  storyRemaining -= Date.now() - startTimeOfStoryMedia;
}
function playStory() {
  if (currentStoryMediaType === "video") {
    currentVideoStoryElement.play();
  }
  currentStoryElement.classList.remove("pause");
  passedMediaThumbElement.style.animationPlayState = "running";
  storyMediaRunningState = true;
  startTimeOfStoryMedia = Date.now();
  handleSetMediaRemainingTime("afterPause");
}
function setIsSeenStorySlideColor(oldIndex, newIndex) {
  listSlideElement[oldIndex].classList.add("is-seen");
  setIsWatchingStoryColor(oldIndex, newIndex);
}
function setIsWatchingStoryColor(oldIndex, newIndex) {
  listSlideElement[oldIndex].classList.remove("is-watching");
  listSlideElement[newIndex].classList.add("is-watching");
}
function setIsWatchingStoryMedia(oldIndex, newIndex) {
  listStoryMediaElement[oldIndex].classList.remove("is-active");
  listStoryMediaElement[newIndex].classList.add("is-active");
}
//Condition function
function isTheLastStory() {
  const currentStoryLength = storiesArr.length - 1;
  return (
    currentStoryIndex >= currentStoryLength &&
    currentStoryMediaIndex >= currentStoryItemLength
  );
}
function isTheLastStoryMedia() {
  const currentStoryItemLength =
    storiesArr[currentStoryIndex].images.length - 1;
  return currentStoryMediaIndex >= currentStoryItemLength;
}
function isTheFirstStory() {
  return currentStoryIndex === 0 && currentStoryMediaIndex === 0;
}
function isTheFirstStoryMedia() {
  return currentStoryMediaIndex === 0 && currentStoryIndex > 0;
}
///
function saveIsWatchingStoryItemToArray(index) {
  storiesArr[currentStoryIndex].isWatching = index;
}
storyNextBtnElement.addEventListener("click", nextStoryMedia);
function nextStoryMedia() {
  if (isTheLastStory()) {
    return;
  }
  setStoryMediaRemainingTime(5000);
  clearTimeout(storyMediaTimeout);
  if (isTheLastStoryMedia()) {
    setIsSeenStorySlideColor(currentStoryIndex, currentStoryIndex + 1);
    storiesArr[currentStoryIndex].isSeen = true;
    currentStoryIndex++;
    currentStoryMediaIndex = 0;
    renderStoryMedia();
    saveIsWatchingStoryItemToArray(currentStoryIndex);
    return;
  }
  setIsWatchingStoryMedia(currentStoryMediaIndex, currentStoryMediaIndex + 1);
  currentStoryMediaIndex++;
  saveIsWatchingStoryItemToArray(currentStoryMediaIndex);
  renderStoryMedia();
}

storyPrevBtnElement.addEventListener("click", prevStoryMedia);
function prevStoryMedia() {
  setStoryMediaRemainingTime(5000);
  clearTimeout(storyMediaTimeout);
  if (isTheFirstStory()) {
    renderStoryMedia();
    return;
  }
  if (isTheFirstStoryMedia()) {
    setIsSeenStorySlideColor(currentStoryIndex, currentStoryIndex - 1);
    currentStoryIndex - 1;
    currentStoryMediaIndex = storiesArr[currentStoryIndex].images.length - 1;
    renderStoryMedia();
    return;
  }
  setIsSeenStorySlideColor(currentStoryMediaIndex, currentStoryMediaIndex - 1);
  setIsWatchingStoryMedia(currentStoryMediaIndex, currentStoryMediaIndex - 1);
  currentStoryMediaIndex--;
  saveIsWatchingStoryItemToArray(currentStoryMediaIndex);
  renderStoryMedia();
}

function saveStoryArrayToLocal(arr) {
  localStorage.setItem("storiesArr", JSON.stringify(arr));
}
