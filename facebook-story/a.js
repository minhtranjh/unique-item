let storiesArr = [
    {
      id: 1,
      owner: "Thanh Minh",
      avatar:
        "https://images.unsplash.com/photo-1494790108377-be9c29b29330?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=2734&q=80",
      images: [
        {
          id: 1,
          src: "/assets/story1.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story2.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story3.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story4.jpeg",
          type: "img",
        },
      ],
    },
    {
      id: 2,
      owner: "Wendy",
      avatar:
        "https://i.pinimg.com/564x/20/6c/f0/206cf049e354147aba5bc5e35796b7ad.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story5.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story6.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story7.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story8.jpeg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story9.jpeg",
          type: "img",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "https://i.pinimg.com/564x/de/43/91/de43917acb4a60625340d8bf9b7fd3c0.jpg",
          type: "img",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
    {
      id: 2,
      owner: "SeungWan",
      avatar:
        "https://i.pinimg.com/564x/ef/37/bc/ef37bcace017597291f8491839552d05.jpg",
      images: [
        {
          id: 1,
          src: "/assets/story10.mp4",
          type: "video",
        },
        {
          id: 1,
          src: "/assets/story11.mp4",
          type: "video",
        },
      ],
    },
  ];
  const wrapper = document.querySelector(".wrapper");
  const slider = document.querySelector(".story-slider");
  const slideBtnLeft = document.querySelector(".btn-left");
  const slideBtnRight = document.querySelector(".btn-right");
  const storyBtnNext = document.querySelector(".next-btn");
  const storyBtnPrev = document.querySelector(".prev-btn");
  
  let storyIndex = 0;
  let curIndex = 0;
  let itemInterval = 0;
  let runningState = true;
  let start;
  let storyRemaining = 5000;
  let thumbstoryRemaining = 5000;
  let slideStyleComputed;
  let slideItem;
  
  function addIsSeenToStory() {
    storiesArr.map((item) => (item.isSeen = false));
  }
  function moveSeenStoryToLast() {
    const arrLocal = JSON.parse(localStorage.getItem("storiesArr"));
    storiesArr = arrLocal && arrLocal.length > 0 ? arrLocal : storiesArr;
    const seenArr = storiesArr.reduce((arr, item) => {
      if (item.isSeen) {
        arr.push({ ...item, isWatching: 0 });
      }
      return arr;
    }, []);
    const notSeenArr = storiesArr.filter((item) => !item.isSeen);
    storiesArr = [...notSeenArr, ...seenArr];
    curIndex = storiesArr[storyIndex].isWatching
      ? storiesArr[storyIndex].isWatching
      : 0;
  }
  addIsSeenToStory();
  moveSeenStoryToLast();
  slideBtnLeft.addEventListener("click", handleSlideLeft);
  function handleSlideLeft(e) {
    slideStyleComputed = window.getComputedStyle(slideItem[0]);
    slider.scrollLeft =
      -(
        slider.scrollLeft +
        slideItem[0].clientWidth +
        parseInt(slideStyleComputed.marginRight, 10)
      ) * 3;
  }
  slideBtnRight.addEventListener("click", handleSlideRight);
  function handleSlideRight() {
    slideStyleComputed = window.getComputedStyle(slideItem[0]);
    slider.scrollLeft =
      (slider.scrollLeft +
        slideItem[0].clientWidth +
        parseInt(slideStyleComputed.marginRight, 10)) *
      3;
  }
  function renderStorySlider() {
    storiesArr.forEach((item, index) => {
      slider.innerHTML += `
          <div onclick="chooseStory(${index})" class="${
        item.isSeen ? "is-seen" : ""
      } ${index === 0 ? "is-watching" : ""}  slide-item">
            <img class="avatar" src="${item.avatar}">
          </div>
        `;
    });
    slideItem = document.querySelectorAll(".slide-item");
  }
  renderStorySlider();
  function chooseStory(index) {
    if (itemInterval) clearTimeout(itemInterval);
    slideItem[storyIndex].classList.remove("is-watching");
    slideItem[index].classList.add("is-watching");
    storyIndex = index;
    const tempIndex = storiesArr[storyIndex].isWatching;
    curIndex = tempIndex ? tempIndex : 0;
    storyRemaining = 5000;
    thumbRemaining = 5000;
    start = Date.now();
    renderStory();
  }
  function renderStory() {
    wrapper.innerHTML = `
    <div onclick="playAndPause()" class="story">
      <div class="time-line">
        ${storiesArr[storyIndex].images.map((item, index) => {
          return `
                <div class="line-wrap ">
          <div class="line"></div>
          <div  class="passed ${index >= curIndex ? "" : "done"}"></div>
        </div>`;
        })}
      </div>
      <div class="slider">
          ${storiesArr[storyIndex].images
            .map((item, childIndex) => {
              return `
              <div class="item ${curIndex === childIndex ? "is-active" : ""} ">
           ${
             item.type === "img"
               ? `<img src="${item.src}" alt="" />`
               : `
          <video class="video" >
              <source src="${item.src}" type="video/mp4">
          </video> `
           }
        </div>`;
            })
            .join("")}
  
      </div>
    </div>`;
    saveStoryToLocal(storiesArr);
    runStoryByType();
  }
  function runStoryByType() {
    const currentStoryType = storiesArr[storyIndex].images[curIndex].type;
    if (currentStoryType === "video") {
      const item = document.querySelectorAll(".item");
      const video = item[curIndex].querySelector(".video");
      video.addEventListener("loadeddata", () => {
        storyRun("beforePause", currentStoryType);
      });
    } else {
      storyRun("beforePause", currentStoryType);
    }
  }
  renderStory();
  
  const lineWrap = document.querySelectorAll(".line-wrap");
  function storyRun(type, currentStoryType) {
    if (type === "beforePause") {
      if (currentStoryType === "video") {
        const item = document.querySelectorAll(".item");
        const video = item[curIndex].querySelector(".video");
        storyRemaining = video.duration * 1000;
        thumbRemaining = video.duration * 1000;
        if (video) {
          video
            .play()
            .then(() => {
              video.play();
              const story = document.querySelector(".story");
              story.classList.remove("pause");
            })
            .catch((error) => {
              playAndPause();
            });
        }
      }
    }
    const passed = document.querySelectorAll(".passed");
    passed[curIndex].style.animation = `thumb ${Math.round(
      (thumbRemaining + 300) / 1000
    )}s linear`;
    start = Date.now();
    itemInterval = setTimeout(() => {
      nextStoryItem();
    }, Math.round(storyRemaining - 100));
  }
  
  function playAndPause() {
    const passed = document.querySelectorAll(".passed");
    const story = document.querySelector(".story");
    const currentStoryType = storiesArr[storyIndex].images[curIndex].type;
    if (itemInterval) clearTimeout(itemInterval);
    if (runningState) {
      if (currentStoryType === "video") {
        const item = document.querySelectorAll(".item");
        const video = item[curIndex].querySelector(".video");
        video.pause();
      }
      story.classList.add("pause");
      storyRemaining -= Date.now() - start;
      passed[curIndex].style.animationPlayState = "paused";
      runningState = false;
    } else {
      story.classList.remove("pause");
      if (currentStoryType === "video") {
        const item = document.querySelectorAll(".item");
        const video = item[curIndex].querySelector(".video");
        video.play();
      }
      passed[curIndex].style.animationPlayState = "running";
      runningState = true;
      start = Date.now();
      storyRun("afterPause");
    }
  }
  storyBtnNext.addEventListener("click", nextStoryItem);
  function nextStoryItem() {
    if (
      storyIndex >= storiesArr.length - 1 &&
      curIndex >= storiesArr[storyIndex].images.length - 1
    ) {
      return;
    }
    storyRemaining = 5000;
    thumbRemaining = 5000;
    if (itemInterval) clearTimeout(itemInterval);
    if (curIndex >= storiesArr[storyIndex].images.length - 1) {
      storiesArr[storyIndex].isSeen = true;
      slideItem[storyIndex].classList.add("is-seen");
      slideItem[storyIndex].classList.remove("is-watching");
      slideItem[storyIndex + 1].classList.add("is-watching");
      storyIndex++;
      curIndex = 0;
      renderStory();
      storiesArr[storyIndex].isWatching = curIndex;
      return;
    }
    const image = document.querySelectorAll(".item");
  
    image[curIndex].classList.remove("is-active");
    image[curIndex + 1].classList.add("is-active");
  
    curIndex++;
    storiesArr[storyIndex].isWatching = curIndex;
  
    renderStory();
  }
  storyBtnPrev.addEventListener("click", prevStoryItem);
  function prevStoryItem() {
    storyRemaining = 5000;
    thumbRemaining = 5000;
    if (itemInterval) clearTimeout(itemInterval);
    if (storyIndex === 0 && curIndex === 0) {
      renderStory();
      return;
    }
    if (curIndex === 0 && storyIndex > 0) {
      storyIndex--;
      curIndex = storiesArr[storyIndex].images.length - 1;
      renderStory();
      return;
    }
    const image = document.querySelectorAll(".item");
    image[curIndex].classList.remove("is-active");
    image[curIndex - 1].classList.add("is-active");
    slideItem[curIndex].classList.remove("is-watching");
    slideItem[curIndex - 1].classList.add("is-watching");
    curIndex--;
    storiesArr[storyIndex].isWatching = curIndex;
    renderStory();
  }
  function saveStoryToLocal(arr) {
    localStorage.setItem("storiesArr", JSON.stringify(arr));
  }
  